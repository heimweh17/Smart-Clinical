<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consultation View - UF Health SmartScribe</title>
  <link rel="stylesheet" href="css/patient-details.css">
  <style>
    /* Print-friendly styling */
    .view-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .view-header {
      background: var(--card);
      border: 2px solid #1E3B70;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .view-section {
      background: var(--card);
      border: 2px solid #1E3B70;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .soap-section {
      margin-bottom: 20px;
    }

    .soap-title {
      color: var(--uf-blue);
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--uf-blue);
    }

    .soap-content {
      background: var(--bg);
      padding: 16px;
      border-radius: 8px;
      line-height: 1.6;
      white-space: pre-wrap;
      color: var(--text);
    }

    .rec-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .rec-item {
      background: rgba(250, 70, 22, 0.05);
      border-left: 3px solid var(--teal);
      padding: 12px;
      border-radius: 6px;
    }

    .rec-title {
      color: var(--teal);
      font-weight: 600;
      font-size: 0.9em;
      margin-bottom: 6px;
    }

    .rec-content {
      font-size: 0.9em;
      line-height: 1.5;
      color: var(--text);
    }

    @media print {
      .back-btn, .action-bar {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header with Back Button -->
    <header class="header">
      <button id="backBtn" class="btn ghost" style="
        position: absolute;
        left: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        cursor: pointer;
      " 
      onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'"
      onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>Back to Documents</span>
      </button>

      <div class="brand" style="margin-left: 200px;">
        <div class="logo">UF</div>
        <div class="title">Health SmartScribe</div>
      </div>
      
      <div class="right" style="margin-left: auto;">
        <span class="facility">UF Health Shands</span>
        <button id="logoutBtn" class="btn ghost" style="margin-left: 16px;">Log Out</button>
      </div>
    </header>

    <!-- Main Content -->
    <div class="view-container">
      
      <!-- Action Bar -->
      <div class="action-bar" style="display: flex; gap: 12px; margin-bottom: 24px; justify-content: flex-end;">
        <button id="printBtn" class="btn">
          ğŸ–¨ï¸ Print
        </button>
        <button id="exportBtn" class="btn accent">
          ğŸ“„ Export
        </button>
      </div>

      <!-- Patient Name, Time, and MRN Only -->
      <div class="view-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin: 0 0 8px 0; color: white; font-size: 1.8em;" id="view-patient-name">
              â€”
            </h2>
            <p style="margin: 0; color: var(--text-secondary); font-size: 1em;">
              MRN: <span id="view-mrn" style="color: var(--text);">â€”</span>
            </p>
          </div>
          <div style="text-align: right;">
            <p style="margin: 0; color: var(--text); font-size: 1.1em; font-weight: 600;" id="view-date">
              â€”
            </p>
          </div>
        </div>
      </div>

      <!-- SOAP Note -->
      <div class="view-section">
        <h3 style="margin: 0 0 20px 0; color: var(--uf-blue); font-size: 1.3em;">SOAP Note</h3>
        
        <div class="soap-section">
          <div class="soap-title">SUBJECTIVE</div>
          <div class="soap-content" id="view-subjective">â€”</div>
        </div>

        <div class="soap-section">
          <div class="soap-title">OBJECTIVE</div>
          <div class="soap-content" id="view-objective">â€”</div>
        </div>

        <div class="soap-section">
          <div class="soap-title">ASSESSMENT</div>
          <div class="soap-content" id="view-assessment">â€”</div>
        </div>

        <div class="soap-section">
          <div class="soap-title">PLAN</div>
          <div class="soap-content" id="view-plan">â€”</div>
        </div>
      </div>

      <!-- AI Recommendations -->
      <div class="view-section" id="recommendations-section">
        <h3 style="margin: 0 0 16px 0; color: var(--teal); font-size: 1.3em;">ğŸ’¡ AI Recommendations</h3>
        
        <div class="rec-grid">
          <div class="rec-item">
            <div class="rec-title">ğŸ’Š Medications</div>
            <div class="rec-content" id="view-rec-meds">â€”</div>
          </div>

          <div class="rec-item">
            <div class="rec-title">ğŸƒ Lifestyle</div>
            <div class="rec-content" id="view-rec-lifestyle">â€”</div>
          </div>

          <div class="rec-item">
            <div class="rec-title">ğŸ“… Follow-up</div>
            <div class="rec-content" id="view-rec-followup">â€”</div>
          </div>

          <div class="rec-item">
            <div class="rec-title">ğŸ“š Education</div>
            <div class="rec-content" id="view-rec-education">â€”</div>
          </div>

          <div class="rec-item">
            <div class="rec-title">ğŸ”¬ Tests</div>
            <div class="rec-content" id="view-rec-tests">â€”</div>
          </div>

          <div class="rec-item">
            <div class="rec-title">ğŸ¥ Referrals</div>
            <div class="rec-content" id="view-rec-referrals">â€”</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>

  <script>
    // Get consultation ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const consultationId = urlParams.get('consultation_id');
    const patientMRN = urlParams.get('mrn');
    const patientName = urlParams.get('name');

    // Back button handler
    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = `dashboard_screen/documents.html?mrn=${patientMRN}&name=${encodeURIComponent(patientName)}`;
    });

    // Print button
    document.getElementById('printBtn').addEventListener('click', () => {
      window.print();
    });

    // Export button
    document.getElementById('exportBtn').addEventListener('click', () => {
      exportConsultationPDF();
    });

    // Load consultation
    async function loadConsultationView() {
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          window.location.href = 'index.html';
          return;
        }

        if (!consultationId) {
          alert('No consultation ID provided');
          return;
        }

        // Fetch consultation
        const { data: consultation, error } = await supabase
          .from('consultations')
          .select('*')
          .eq('id', consultationId)
          .eq('user_id', user.id)
          .single();

        if (error) throw error;

        console.log('Loaded consultation:', consultation);
        populateView(consultation);

      } catch (error) {
        console.error('Error loading consultation:', error);
        alert('Error loading consultation: ' + error.message);
      }
    }

    // Populate view with data - SIMPLIFIED
    function populateView(c) {
      // Only show: Name, MRN, Time
      document.getElementById('view-patient-name').textContent = c.patient_name || 'Unknown Patient';
      document.getElementById('view-mrn').textContent = c.patient_mrn || 'â€”';
      
      const consultDate = new Date(c.consultation_date);
      document.getElementById('view-date').textContent = consultDate.toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // SOAP note
      document.getElementById('view-subjective').textContent = c.soap_subjective || 'Not documented';
      document.getElementById('view-objective').textContent = c.soap_objective || 'Not documented';
      document.getElementById('view-assessment').textContent = c.soap_assessment || 'Not documented';
      document.getElementById('view-plan').textContent = c.soap_plan || 'Not documented';

      // Recommendations
      document.getElementById('view-rec-meds').textContent = c.rec_medications || 'None needed';
      document.getElementById('view-rec-lifestyle').textContent = c.rec_lifestyle || 'None needed';
      document.getElementById('view-rec-followup').textContent = c.rec_followup || 'None needed';
      document.getElementById('view-rec-education').textContent = c.rec_education || 'None needed';
      document.getElementById('view-rec-tests').textContent = c.rec_tests || 'None needed';
      document.getElementById('view-rec-referrals').textContent = c.rec_referrals || 'None needed';

      // Hide recommendations if none exist
      const hasRecommendations = c.rec_medications && c.rec_medications !== 'â€”' && c.rec_medications !== 'None needed';
      if (!hasRecommendations) {
        document.getElementById('recommendations-section').style.display = 'none';
      }
    }

    // Export to file
    function exportConsultationPDF() {
      const patientName = document.getElementById('view-patient-name').textContent;
      const mrn = document.getElementById('view-mrn').textContent;
      const date = document.getElementById('view-date').textContent;
      
      const content = `
UF HEALTH SMARTSCRIBE - CONSULTATION REPORT
============================================

PATIENT: ${patientName}
MRN: ${mrn}
DATE: ${date}

SOAP NOTE
---------

SUBJECTIVE:
${document.getElementById('view-subjective').textContent}

OBJECTIVE:
${document.getElementById('view-objective').textContent}

ASSESSMENT:
${document.getElementById('view-assessment').textContent}

PLAN:
${document.getElementById('view-plan').textContent}

AI RECOMMENDATIONS
------------------
ğŸ’Š Medications: ${document.getElementById('view-rec-meds').textContent}
ğŸƒ Lifestyle: ${document.getElementById('view-rec-lifestyle').textContent}
ğŸ“… Follow-up: ${document.getElementById('view-rec-followup').textContent}
ğŸ“š Education: ${document.getElementById('view-rec-education').textContent}
ğŸ”¬ Tests: ${document.getElementById('view-rec-tests').textContent}
ğŸ¥ Referrals: ${document.getElementById('view-rec-referrals').textContent}

============================================
Generated by UF Health SmartScribe
`;

      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `consultation-${mrn}-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      URL.revokeObjectURL(url);
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const success = await signOut();
      if (success) {
        window.location.href = 'index.html';
      }
    });

    // Load on page load
    (async () => {
      await protectPage();
      await loadConsultationView();
    })();
  </script>
</body>
</html>